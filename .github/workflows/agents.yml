name: Agent Company Pipeline

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * *'  # GÃ¼nde 1 kez, saat 09:00 TRT

permissions:
  contents: write
  issues: write

jobs:
  process-ideas:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Seed daily idea template (free mode)
        run: |
          python3 tools/seed_ideas.py
      
      - name: Check for CEO approval
        id: check_approval
        run: |
          if grep -q "^APPROVED: IDEA-[0-9]\+" docs/IDEAS.md; then
            APPROVED_IDEA=$(grep "^APPROVED: IDEA-[0-9]\+" docs/IDEAS.md | head -1)
            echo "approval_found=true" >> $GITHUB_OUTPUT
            echo "approved_idea=$APPROVED_IDEA" >> $GITHUB_OUTPUT
            echo "âœ… Approval found: $APPROVED_IDEA"
          else
            echo "approval_found=false" >> $GITHUB_OUTPUT
            echo "âŒ CEO approval not found in docs/IDEAS.md"
            echo "Add 'APPROVED: IDEA-X' to proceed."
            exit 0
          fi
      
      - name: Extract approved IDEA details
        if: steps.check_approval.outputs.approval_found == 'true'
        id: extract_idea
        run: |
          IDEA_ID=$(echo "${{ steps.check_approval.outputs.approved_idea }}" | sed 's/APPROVED: //')
          echo "idea_id=$IDEA_ID" >> $GITHUB_OUTPUT
          echo "Extracted IDEA: $IDEA_ID"
          
          IDEA_BLOCK=$(awk "/$IDEA_ID:/,/^###|^$/" docs/IDEAS.md | head -30)
          echo "idea_block<<EOF" >> $GITHUB_OUTPUT
          echo "$IDEA_BLOCK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Update PRD with approved IDEA
        if: steps.check_approval.outputs.approval_found == 'true'
        id: update_prd
        run: |
          cp docs/PRD.md docs/PRD.md.backup
          
          python3 << 'PYTHON_SCRIPT'
          import re
          
          with open('docs/PRD.md', 'r', encoding='utf-8') as f:
              content = f.read()
          
          idea_block = """${{ steps.extract_idea.outputs.idea_block }}"""
          
          pattern = r'## SeÃ§ilen Fikir\n\n\[Workflow tarafÄ±ndan doldurulacak - IDEA-X bilgileri\]'
          replacement = f'## SeÃ§ilen Fikir\n\n{idea_block}'
          
          new_content = re.sub(pattern, replacement, content)
          
          with open('docs/PRD.md', 'w', encoding='utf-8') as f:
              f.write(new_content)
          
          print("âœ… PRD updated with approved IDEA")
          PYTHON_SCRIPT
          
          echo "prd_updated=true" >> $GITHUB_OUTPUT
      
      - name: Check if PRD changed
        if: steps.check_approval.outputs.approval_found == 'true'
        id: check_prd_diff
        run: |
          if ! diff -q docs/PRD.md.backup docs/PRD.md > /dev/null 2>&1; then
            echo "prd_changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ PRD file was modified"
          else
            echo "prd_changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ PRD file unchanged"
          fi

      - name: Create PM Backlog issues
        if: steps.check_approval.outputs.approval_found == 'true'
        run: |
          # Issue 1: PRD refinement
          if ! gh issue list --search "PM Backlog: PRD'yi netleÅŸtir" --state open | grep -q .; then
            gh issue create \
              --title "PM Backlog: PRD'yi netleÅŸtir" \
              --body "## GÃ¶rev
          OnaylÄ± IDEA iÃ§in PRD belgesini kesinleÅŸtir.
          
          ### YapÄ±lacaklar
          - [ ] Problem tanÄ±mÄ±nÄ± detaylandÄ±r
          - [ ] User personas'Ä± somutlaÅŸtÄ±r
          - [ ] Solution'u teknik aÃ§Ä±dan detaylandÄ±r
          - [ ] User stories + acceptance criteria'larÄ± yaz
          - [ ] KPI'larÄ± define et
          
          ### Acceptance Criteria
          - [ ] PRD tamamlanmÄ±ÅŸ
          - [ ] TÃ¼m US'lerde AC var
          - [ ] CEO onayÄ± alÄ±ndÄ±" \
              --label "pm"
          fi
          
          # Issue 2: Roadmap planning
          if ! gh issue list --search "PM Backlog: Roadmap'i Sprint bazÄ±nda kesinleÅŸtir" --state open | grep -q .; then
            gh issue create \
              --title "PM Backlog: Roadmap'i Sprint bazÄ±nda kesinleÅŸtir" \
              --body "## GÃ¶rev
          14 gÃ¼nlÃ¼k MVP iÃ§in sprint planÄ± yap.
          
          ### YapÄ±lacaklar
          - [ ] Sprint 1 (7 gÃ¼n) tasks tanÄ±mla
          - [ ] Sprint 2 (7 gÃ¼n) tasks tanÄ±mla
          - [ ] Dependencies haritala
          - [ ] Team capacity'a gÃ¶re allocate et
          
          ### Acceptance Criteria
          - [ ] Roadmap.md tamamlanmÄ±ÅŸ
          - [ ] 14 gÃ¼n + post-MVP safhasÄ± tanÄ±mlanmÄ±ÅŸ" \
              --label "pm"
          fi
          
          # Issue 3: User flow
          if ! gh issue list --search "PM Backlog: MVP ekran akÄ±ÅŸÄ±nÄ± Ã§Ä±kar" --state open | grep -q .; then
            gh issue create \
              --title "PM Backlog: MVP ekran akÄ±ÅŸÄ±nÄ± Ã§Ä±kar" \
              --body "## GÃ¶rev
          MVP iÃ§in user flow ve wireframe hazÄ±rla.
          
          ### YapÄ±lacaklar
          - [ ] User journey map'Ä± Ã§iz
          - [ ] Kritik ekran flow'unu tanÄ±mla
          - [ ] Wireframe/mockup oluÅŸtur (Figma/excalidraw)
          - [ ] Dev team'le align et
          
          ### Acceptance Criteria
          - [ ] Flow diagram tamamlanmÄ±ÅŸ
          - [ ] TÃ¼m ekranlar identified" \
              --label "pm,design"
          fi
          
          # Issue 4: Test plan update
          if ! gh issue list --search "PM Backlog: Test Plan taslaÄŸÄ±nÄ± gÃ¼ncelle" --state open | grep -q .; then
            gh issue create \
              --title "PM Backlog: Test Plan taslaÄŸÄ±nÄ± gÃ¼ncelle" \
              --body "## GÃ¶rev
          MVP scope'una gÃ¶re test plan'Ä± detaylandÄ±r.
          
          ### YapÄ±lacaklar
          - [ ] Happy path test cases tanÄ±mla
          - [ ] Edge case'leri dÃ¼ÅŸÃ¼n
          - [ ] Error scenarios'larÄ± ekle
          - [ ] UX test strategy hazÄ±rla
          
          ### Acceptance Criteria
          - [ ] Test.md 85%+ MVP coverage var
          - [ ] TÃ¼m test cases documented" \
              --label "qa"
          fi
          
          echo "âœ… PM Backlog issues created/verified"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit and push PRD update
        if: steps.check_approval.outputs.approval_found == 'true' && steps.check_prd_diff.outputs.prd_changed == 'true'
        run: |
          git config --local user.email "bot@agent-company.dev"
          git config --local user.name "Agent Company Bot"
          
          git add docs/PRD.md
          git commit -m "ðŸ¤– [AUTOMATED] Update PRD with ${{ steps.extract_idea.outputs.idea_id }}"
          git push
          
          echo "âœ… PRD changes committed and pushed"
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”„ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_approval.outputs.approval_found }}" == "true" ]; then
            echo "âœ… **CEO Approval**: ${{ steps.check_approval.outputs.approved_idea }}" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **IDEA Extracted**: ${{ steps.extract_idea.outputs.idea_id }}" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **PRD Updated**: Yes (${{ steps.check_prd_diff.outputs.prd_changed }})" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Issues Created**: PM Backlog (4 items)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: CEO approval not found" >> $GITHUB_STEP_SUMMARY
            echo "âž¡ï¸ **Action**: Add 'APPROVED: IDEA-X' to docs/IDEAS.md" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
